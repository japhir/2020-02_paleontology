<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-04-01 Wed 13:43 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Practical 8</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Ilja Kocken" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Practical 8</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org526fe31">1. read the data</a></li>
<li><a href="#orgc8cd576">2. Graph of the species number per locality.</a></li>
<li><a href="#orgdef444c">3. Graph of habitat preference</a>
<ul>
<li><a href="#org79ee86b">3.1. tidy the data</a></li>
<li><a href="#org60e57d3">3.2. create the plot</a></li>
<li><a href="#org37a8e49">3.3. what's up at 16 Ma?</a></li>
</ul>
</li>
<li><a href="#orge3750a6">4. Graph of Diversity and Equity</a>
<ul>
<li><a href="#org68574f7">4.1. compute diversity and equity</a>
<ul>
<li><a href="#org6d33a8d">4.1.1. by column</a></li>
<li><a href="#org54dca3c">4.1.2. tidy</a></li>
</ul>
</li>
<li><a href="#org79ef2d9">4.2. create the plots</a></li>
</ul>
</li>
<li><a href="#org82af016">5. conclusion</a></li>
<li><a href="#orga91f8a8">6. sessionInfo</a></li>
</ul>
</div>
</div>

<div id="outline-container-org526fe31" class="outline-2">
<h2 id="org526fe31"><span class="section-number-2">1</span> read the data</h2>
<div class="outline-text-2" id="text-1">
<p>
I prepared a slightly cleaner CSV sheet, which we can read into R more easily.
You can download it <a href="https://github.com/japhir/2020-02_paleontology/blob/master/biostrat_clean.csv">here</a>.
</p>

<p>
I rename some columns here so that I can type less and we don't have spaces in
the column names.
</p>

<div class="org-src-container">
<pre class="src src-R">strat <span style="color: #a9a1e1;">&lt;-</span> read_csv<span style="color: #51afef;">(</span><span style="color: #98be65;">"biostrat_clean.csv"</span>, skip = 1<span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  rename<span style="color: #51afef;">(</span>c<span style="color: #c678dd;">(</span>bio = <span style="color: #98be65;">"LOCAL BIOZONE"</span>, age = <span style="color: #98be65;">"NUMERICAL AGE in MA"</span>, loc = <span style="color: #98be65;">"LOCCODE"</span>, n_m12 = <span style="color: #98be65;">"N M12"</span>, N = <span style="color: #98be65;">"N of SPECIES"</span>,
         dry = <span style="color: #98be65;">"% DRY RODENTS"</span>, catholic = <span style="color: #98be65;">"% CATHOLIC"</span>, wet = <span style="color: #98be65;">"% WET RODENTS"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  select<span style="color: #51afef;">(</span>-LOCCODE_1<span style="color: #51afef;">)</span>
</pre>
</div>

<p>
The output tells us how it read the csv file and what types each column was
identified as.
</p>

<p>
You can also read in the raw excel file directly with the package <code>readxl</code> if you
want.
</p>
</div>
</div>

<div id="outline-container-orgc8cd576" class="outline-2">
<h2 id="orgc8cd576"><span class="section-number-2">2</span> Graph of the species number per locality.</h2>
<div class="outline-text-2" id="text-2">
<p>
The first exercise is the easiest. We take our data <code>strat</code> and pipe it (<code>%&gt;%</code>) to
the <code>ggplot</code> function. You can read this as: take <code>strat</code> and then do <code>ggplot</code> with
it.
</p>

<p>
Within the plot we specify so-called aesthetics with <code>aes</code>. This links columns of
the data to things we can plot, in this case <code>x</code> and <code>y</code> for a simple scatter plot.
Because we are dealing with a time series (albeit a discontinuos one) it is
customary to plot the series with a line, which we add with <code>geom_line</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">strat <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = age, y = N<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_line<span style="color: #51afef;">()</span> +
  labs<span style="color: #51afef;">(</span>x = <span style="color: #98be65;">"Age (Ma)"</span>, y = <span style="color: #98be65;">"Number of species"</span><span style="color: #51afef;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="https://raw.githubusercontent.com/japhir/2020-02_paleontology/master/n_spec.png" alt="n_spec.png" />
</p>
</div>

<p>
To learn more about creating plots with <code>ggplot2</code>, I highly recommend following
the online course <a href="https://www.datacamp.com/courses/data-visualization-with-ggplot2-1">data visualisation with ggplot2</a> and <a href="https://r4ds.had.co.nz/data-visualisation.html">chapter 3 of r4ds: data
visualisation</a>.
</p>

<p>
If you don't like the gray grid behind the data, have a look at <code>?theme</code>. You can
easily change the plot to a black and white classical plot with a <code>+
theme_classic()</code> at the end.
</p>
</div>
</div>

<div id="outline-container-orgdef444c" class="outline-2">
<h2 id="orgdef444c"><span class="section-number-2">3</span> Graph of habitat preference</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org79ee86b" class="outline-3">
<h3 id="org79ee86b"><span class="section-number-3">3.1</span> tidy the data</h3>
<div class="outline-text-3" id="text-3-1">
<p>
For this plot we need to re-arrange the data a little bit. Right now all the
percentages of the rodents are in different column. For easy plotting and data
processing, usually we want so-called <code>tidy</code> data. This means that each row
corresponds to one observation.
</p>

<p>
In this case that would mean we'd repeat the age and location code three times,
with one new variable <code>percentage</code> and another with the <code>habitat</code>.
</p>

<div class="org-src-container">
<pre class="src src-R">strat_hab <span style="color: #a9a1e1;">&lt;-</span> strat <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">remove all non-essential columns and rename for easy access</span>
  select<span style="color: #51afef;">(</span>age, loc, dry, catholic, wet<span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">convert to long-format (this is something to look up and learn!)</span>
  pivot_longer<span style="color: #51afef;">(</span>cols = c<span style="color: #c678dd;">(</span>dry, catholic, wet<span style="color: #c678dd;">)</span>, values_to = <span style="color: #98be65;">"percentage"</span>, names_to = <span style="color: #98be65;">"habitat"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<p>
To illustrate, we switch from:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
to:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
read up on creating tidy data in <a href="https://r4ds.had.co.nz/tidy-data.html">r4ds chapter 12</a>.
</p>
</div>
</div>

<div id="outline-container-org60e57d3" class="outline-3">
<h3 id="org60e57d3"><span class="section-number-3">3.2</span> create the plot</h3>
<div class="outline-text-3" id="text-3-2">
<p>
With the tidy data, creating an area chart is very easy:
</p>
<div class="org-src-container">
<pre class="src src-R">strat_hab <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = age, y = percentage, fill = factor<span style="color: #98be65;">(</span>habitat, levels = c<span style="color: #da8548;">(</span><span style="color: #98be65;">"dry"</span>, <span style="color: #98be65;">"catholic"</span>, <span style="color: #98be65;">"wet"</span><span style="color: #da8548;">)</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">this plots each line as a polygon</span>
  geom_area<span style="color: #51afef;">()</span> +
  scale_fill_manual<span style="color: #51afef;">(</span>values = c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"dry"</span> = <span style="color: #98be65;">"orange3"</span>, <span style="color: #98be65;">"catholic"</span> = <span style="color: #98be65;">"brown4"</span>, <span style="color: #98be65;">"wet"</span> = <span style="color: #98be65;">"blue4"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  labs<span style="color: #51afef;">(</span>x = <span style="color: #98be65;">"Age (Ma)"</span>, y = <span style="color: #98be65;">"Abundance (%)"</span>, fill = <span style="color: #98be65;">"Habitat preference"</span><span style="color: #51afef;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="https://raw.githubusercontent.com/japhir/2020-02_paleontology/master/habitat_pref.png" alt="habitat_pref.png" />
</p>
</div>

<p>
Here we adjust the colours manually. Note that generally it's not nice to use
manual colour scales because it's hard to estimate what colourblind people are
able to see well. In this case, with only 3 values and where specific colours
can make intuitive sense, I set it manually. I like to use
<code>viridis::scale_fill_viridis</code> often!
</p>

<p>
Oh, and what does <code>::</code> mean you ask? It means: look in package <code>viridis</code> for the
function <code>scale_fill_viridis</code>.
</p>
</div>
</div>

<div id="outline-container-org37a8e49" class="outline-3">
<h3 id="org37a8e49"><span class="section-number-3">3.3</span> what's up at 16 Ma?</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Notice the weird outlier near 16 Ma, where the total is larger than 100%!
</p>

<p>
Let's figure out which sample it is.
</p>

<div class="org-src-container">
<pre class="src src-R">strat_hab <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  group_by<span style="color: #51afef;">(</span>age, loc<span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>total = sum<span style="color: #c678dd;">(</span>percentage<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">filter those rows where the percentage is not 100</span>
  filter<span style="color: #51afef;">(</span>total &gt; 100 | total &lt; 100<span style="color: #51afef;">)</span>
</pre>
</div>

<p>
You will always have some noise in your data. With R, it's quite easy to drill
down into where it is and what causes it. Unfortunately, it won't stop you from
making mistakes in the first place 😉.
</p>
</div>
</div>
</div>

<div id="outline-container-orge3750a6" class="outline-2">
<h2 id="orge3750a6"><span class="section-number-2">4</span> Graph of Diversity and Equity</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org68574f7" class="outline-3">
<h3 id="org68574f7"><span class="section-number-3">4.1</span> compute diversity and equity</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Read the handout about how we calculate diversity and equity.
</p>
</div>

<div id="outline-container-org6d33a8d" class="outline-4">
<h4 id="org6d33a8d"><span class="section-number-4">4.1.1</span> by column</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
We <code>mutate_at</code> here to do calculations for many columns. However, this is an
instance in which having this as tidy data would make some more complex examples
easier!
</p>

<p>
First we'll do the calculations in the way the dataframe is already set up.
</p>

<div class="org-src-container">
<pre class="src src-R">strat_div <span style="color: #a9a1e1;">&lt;-</span> strat <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">first square all the species abundances</span>
  mutate_at<span style="color: #51afef;">(</span>vars<span style="color: #c678dd;">(</span>D.franconicus:Keramidomys<span style="color: #c678dd;">)</span>, ~ . ^ 2<span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">this overwrites the columns! use a named list if you want new columns in</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">stead. then calculate diversity and evennes</span>
  mutate<span style="color: #51afef;">(</span>diversity = 1 / <span style="color: #c678dd;">(</span>rowSums<span style="color: #98be65;">(</span>select<span style="color: #da8548;">(</span>., D.franconicus:Keramidomys<span style="color: #da8548;">)</span>, na.rm = <span style="color: #ECBE7B;">TRUE</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>,
         evenness = diversity / N<span style="color: #51afef;">)</span>
</pre>
</div>

<p>
You don't have to understand all the steps here, since this is not the approach
I would recommend.
</p>
</div>
</div>

<div id="outline-container-org54dca3c" class="outline-4">
<h4 id="org54dca3c"><span class="section-number-4">4.1.2</span> tidy</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
In stead, I would recommend to tidy your data as follows:
</p>

<div class="org-src-container">
<pre class="src src-R">tidystrat <span style="color: #a9a1e1;">&lt;-</span> strat <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">remove the columns we are not interested in</span>
  select<span style="color: #51afef;">(</span>-c<span style="color: #c678dd;">(</span>dry, catholic, wet, n_m12<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">convert the species abundances to tidy format</span>
  pivot_longer<span style="color: #51afef;">(</span>D.franconicus:Keramidomys, names_to = <span style="color: #98be65;">"species"</span>, values_to = <span style="color: #98be65;">"abundance"</span><span style="color: #51afef;">)</span>

ev <span style="color: #a9a1e1;">&lt;-</span> tidystrat <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">and for each age and locality, original row</span>
  group_by<span style="color: #51afef;">(</span>age, loc<span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">calculate the diversity (be very careful where you place parentheses!)</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">notice that now we don't have to calculate the squares first.</span>
  summarize<span style="color: #51afef;">(</span>diversity = 1 / sum<span style="color: #c678dd;">(</span>abundance ^ 2, na.rm = <span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span>,
            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">calculate the number of species</span>
            n_manual = sum<span style="color: #c678dd;">(</span>abundance &gt; 0, na.rm = <span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span>,
            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">and for comparison get the ones from the original sheet</span>
            n_from_sheet = mean<span style="color: #c678dd;">(</span>N, na.rm = <span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">calculate evenness</span>
  mutate<span style="color: #51afef;">(</span>evenness = diversity / n_manual<span style="color: #51afef;">)</span>
</pre>
</div>

<p>
While this is a little bit more code, I think it is more legible and it will
make the next steps easier.
</p>

<p>
Inspect <code>tidystrat</code> to see what it looks like!
</p>
<div class="org-src-container">
<pre class="src src-R">head<span style="color: #51afef;">(</span>tidystrat<span style="color: #51afef;">)</span>
</pre>
</div>

<p>
Note that again the <code>N of SPECIES</code> in the original sheet is slightly different from our calculated one:
</p>
<div class="org-src-container">
<pre class="src src-R">ev <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>n_manual != n_from_sheet<span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org79ef2d9" class="outline-3">
<h3 id="org79ef2d9"><span class="section-number-3">4.2</span> create the plots</h3>
<div class="outline-text-3" id="text-4-2">
<p>
First we create the plot based on <code>strat_div</code>, the original data with the new
columns for diversity and evenness. We create two separate plots and then add
them together as subplots using the package <code>patchwork</code>. This is perfect when you
have to make many adjustments to your subfigures.
</p>

<div class="org-src-container">
<pre class="src src-R">p_div <span style="color: #a9a1e1;">&lt;-</span> strat_div <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = age, y = diversity<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_line<span style="color: #51afef;">()</span> +
  labs<span style="color: #51afef;">(</span>y = <span style="color: #98be65;">"Diversity"</span><span style="color: #51afef;">)</span>
p_eq <span style="color: #a9a1e1;">&lt;-</span> strat_div <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = age, y = evenness<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_line<span style="color: #51afef;">()</span> +
  labs<span style="color: #51afef;">(</span>y = <span style="color: #98be65;">"Evenness"</span><span style="color: #51afef;">)</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">we use patchwork to put the two pluts together</span>
<span style="color: #51afef;">(</span>p_div &amp; theme<span style="color: #c678dd;">(</span>axis.title.x = element_blank<span style="color: #98be65;">()</span>, axis.text.x = element_blank<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> / p_eq + labs<span style="color: #51afef;">(</span>x = <span style="color: #98be65;">"Age (Ma)"</span><span style="color: #51afef;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="https://raw.githubusercontent.com/japhir/2020-02_paleontology/master/diversity.png" alt="diversity.png" />
</p>
</div>

<p>
And to show that the tidy way results in the same plot, we tidy the data even
further and then using <code>facets</code>.
</p>
<div class="org-src-container">
<pre class="src src-R">ev <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  select<span style="color: #51afef;">(</span>age, loc, diversity, evenness<span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  pivot_longer<span style="color: #51afef;">(</span>diversity:evenness, names_to = <span style="color: #98be65;">"measure"</span>, values_to = <span style="color: #98be65;">"value"</span><span style="color: #51afef;">)</span> <span style="color: #bbc2cf; background-color: #282c34;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = age, y = value<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_line<span style="color: #51afef;">()</span> +
  facet_grid<span style="color: #51afef;">(</span>rows = vars<span style="color: #c678dd;">(</span>measure<span style="color: #c678dd;">)</span>, scales = <span style="color: #98be65;">"free_y"</span><span style="color: #51afef;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="https://raw.githubusercontent.com/japhir/2020-02_paleontology/master/tidy_diversity.png" alt="tidy_diversity.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org82af016" class="outline-2">
<h2 id="org82af016"><span class="section-number-2">5</span> conclusion</h2>
<div class="outline-text-2" id="text-5">
<p>
This was a quick look into some of the features of <code>R</code> for data analysis and
plotting. I hope this will have peaked your interest and will get you to use
excel only as a way of entering data ;-).
</p>
</div>
</div>

<div id="outline-container-orga91f8a8" class="outline-2">
<h2 id="orga91f8a8"><span class="section-number-2">6</span> sessionInfo</h2>
<div class="outline-text-2" id="text-6">
<p>
This just shows you which version of R and which packages I have installed in
case there are future updates.
</p>

<div class="org-src-container">
<pre class="src src-R">sessionInfo<span style="color: #51afef;">()</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Ilja Kocken</p>
<p class="date">Created: 2020-04-01 Wed 13:43</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
